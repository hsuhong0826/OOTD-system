"""
å¤©æ°£ API æ•´åˆæ¨¡çµ„
ä½¿ç”¨ä¸­å¤®æ°£è±¡ç½²é–‹æ”¾è³‡æ–™ API å–å¾—å°ç£å¤©æ°£è³‡è¨Š
"""

import os
from pathlib import Path
import requests
from datetime import datetime, timedelta
from typing import List, Dict, Optional

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸ (åƒ…åœ¨æœ¬åœ°é–‹ç™¼æ™‚éœ€è¦)
if Path(".env").exists():
    from dotenv import load_dotenv

    load_dotenv()

# ä¸­å¤®æ°£è±¡ç½² API é‡‘é‘°ï¼ˆå…è²»ç”³è«‹ï¼šhttps://opendata.cwa.gov.tw/ï¼‰
CWA_API_KEY = os.environ.get("CWA_API_KEY", "")

# OpenWeatherMap API é‡‘é‘°ï¼ˆå‚™ç”¨ï¼‰
OPENWEATHER_API_KEY = os.environ.get("OPENWEATHER_API_KEY", "")


def get_coordinates(city_name: str) -> Optional[tuple]:
    """å–å¾—åŸå¸‚åº§æ¨™ï¼ˆå°ç£åŸå¸‚å°ç…§ï¼‰"""
    # å°ç£ä¸»è¦åŸå¸‚åº§æ¨™å°ç…§è¡¨
    taiwan_cities = {
        # æ–°åŒ—å¸‚å€åŸŸ
        "æ³°å±±": (25.0563, 121.4336),
        "æ¿æ©‹": (25.0083, 121.4592),
        "æ–°åŒ—": (25.0118, 121.4652),
        "è¬è¯": (25.0320, 121.5000),
        "æ¨¹æ—": (24.9933, 121.4205),
        "ä¸‰é‡": (25.0620, 121.4875),
        "æ–°èŠ": (25.0378, 121.4326),
        "ä¸­å’Œ": (24.9989, 121.4993),
        "æ°¸å’Œ": (25.0108, 121.5161),
        "åœŸåŸ": (24.9739, 121.4421),
        "è˜†æ´²": (25.0847, 121.4741),
        "æ±æ­¢": (25.0674, 121.6423),
        "æ·¡æ°´": (25.1677, 121.4406),
        "ç‘èŠ³": (25.1093, 121.8120),
        "ä¸‰å³½": (24.9344, 121.3691),
        "é¶¯æ­Œ": (24.9545, 121.3542),
        "æ–°åº—": (24.9677, 121.5414),
        "æ·±å‘": (25.0024, 121.6170),
        "çŸ³ç¢‡": (24.9861, 121.6578),
        "åªæ—": (24.9367, 121.7103),
        "çƒä¾†": (24.8657, 121.5495),
        "äº”è‚¡": (25.0829, 121.4389),
        "å…«é‡Œ": (25.1498, 121.4012),
        "æ—å£": (25.0776, 121.3903),
        "ä¸‰èŠ": (25.2572, 121.5019),
        "çŸ³é–€": (25.2906, 121.5667),
        "é‡‘å±±": (25.2215, 121.6368),
        "è¬é‡Œ": (25.1796, 121.6892),
        "å¹³æºª": (25.0259, 121.7395),
        "é›™æºª": (25.0332, 121.8653),
        "è²¢å¯®": (25.0193, 121.9081),
        # å°åŒ—å¸‚
        "å°åŒ—": (25.0330, 121.5654),
        "å£«æ—": (25.0875, 121.5160),
        "åŒ—æŠ•": (25.1319, 121.5018),
        "å…§æ¹–": (25.0826, 121.5907),
        "å—æ¸¯": (25.0527, 121.6063),
        "æ¾å±±": (25.0496, 121.5779),
        "ä¿¡ç¾©": (25.0330, 121.5770),
        "å¤§å®‰": (25.0263, 121.5436),
        "ä¸­å±±": (25.0636, 121.5260),
        "ä¸­æ­£": (25.0320, 121.5200),
        "å¤§åŒ": (25.0632, 121.5155),
        "æ–‡å±±": (24.9889, 121.5706),
        # åŸºéš†å¸‚
        "åŸºéš†": (25.1276, 121.7392),
        # æ¡ƒåœ’å¸‚
        "æ¡ƒåœ’": (24.9936, 121.3010),
        "ä¸­å£¢": (24.9659, 121.2257),
        "å¹³é®": (24.9444, 121.2164),
        "å…«å¾·": (24.9404, 121.2967),
        "æ¥Šæ¢…": (24.9075, 121.1460),
        "è˜†ç«¹": (25.0455, 121.2918),
        "å¤§æºª": (24.8804, 121.2865),
        "é¾æ½­": (24.8643, 121.2164),
        "é¾œå±±": (25.0407, 121.3540),
        "å¤§åœ’": (25.0606, 121.1969),
        "è§€éŸ³": (25.0354, 121.0826),
        "æ–°å±‹": (24.9703, 121.1060),
        "å¾©èˆˆ": (24.8200, 121.3500),
        # æ–°ç«¹å¸‚
        "æ–°ç«¹": (24.8138, 120.9675),
        # æ–°ç«¹ç¸£
        "ç«¹åŒ—": (24.8387, 121.0052),
        "ç«¹æ±": (24.7404, 121.0887),
        "æ–°åŸ”": (24.8372, 121.0759),
        "é—œè¥¿": (24.7887, 121.1775),
        "æ¹–å£": (24.8998, 121.0388),
        "æ–°è±": (24.9019, 120.9839),
        "å³¨çœ‰": (24.6883, 121.0094),
        "å¯¶å±±": (24.7494, 120.9965),
        "åŒ—åŸ”": (24.7000, 121.0583),
        "èŠæ—": (24.7711, 121.0750),
        "æ©«å±±": (24.7173, 121.1181),
        "å°–çŸ³": (24.7025, 121.2000),
        "äº”å³°": (24.5967, 121.1100),
        # è‹—æ —ç¸£
        "è‹—æ —": (24.5602, 120.8214),
        "é ­ä»½": (24.6968, 120.8967),
        "ç«¹å—": (24.6877, 120.8736),
        "è‹‘è£¡": (24.4431, 120.6515),
        "é€šéœ„": (24.4897, 120.6778),
        "å¾Œé¾": (24.6127, 120.7863),
        "å“è˜­": (24.3100, 120.8267),
        "å¤§æ¹–": (24.4219, 120.8647),
        "å…¬é¤¨": (24.5084, 120.8225),
        "éŠ…é‘¼": (24.4867, 120.7855),
        "å—åº„": (24.5953, 121.0089),
        "é ­å±‹": (24.5896, 120.8484),
        "ä¸‰ç¾©": (24.4133, 120.7583),
        "è¥¿æ¹–": (24.5650, 120.7833),
        "é€ æ©‹": (24.6369, 120.8500),
        "ä¸‰ç£": (24.6567, 120.9567),
        "ç…æ½­": (24.5383, 120.9217),
        "æ³°å®‰": (24.4600, 121.0000),
        # å°ä¸­å¸‚
        "å°ä¸­": (24.1477, 120.6736),
        "è±åŸ": (24.2569, 120.7233),
        "å¤§é‡Œ": (24.0992, 120.6773),
        "å¤ªå¹³": (24.1245, 120.7239),
        "æ¸…æ°´": (24.2643, 120.5694),
        "æ²™é¹¿": (24.2368, 120.5686),
        "å¤§ç”²": (24.3475, 120.6244),
        "æ±å‹¢": (24.2588, 120.8239),
        "æ¢§æ£²": (24.2554, 120.5289),
        "çƒæ—¥": (24.1051, 120.6236),
        "ç¥å²¡": (24.2569, 120.6631),
        "å¤§è‚š": (24.1531, 120.5408),
        "å¤§é›…": (24.2289, 120.6478),
        "åé‡Œ": (24.3045, 120.7142),
        "éœ§å³°": (24.0592, 120.6997),
        "æ½­å­": (24.2097, 120.7069),
        "é¾äº•": (24.1928, 120.5433),
        "å¤–åŸ”": (24.3311, 120.6556),
        "å’Œå¹³": (24.2939, 121.0417),
        "çŸ³å²¡": (24.2733, 120.7833),
        "å¤§å®‰": (24.3456, 120.5931),
        "æ–°ç¤¾": (24.2333, 120.8083),
        # å½°åŒ–ç¸£
        "å½°åŒ–": (24.0518, 120.5161),
        "å“¡æ—": (23.9589, 120.5742),
        "å’Œç¾": (24.1100, 120.4961),
        "é¹¿æ¸¯": (24.0558, 120.4344),
        "æºªæ¹–": (23.9589, 120.4814),
        "äºŒæ—": (23.9267, 120.4086),
        "ç”°ä¸­": (23.8600, 120.5858),
        "åŒ—æ–—": (23.8706, 120.5211),
        "èŠ±å£‡": (24.0264, 120.5436),
        "èŠ¬åœ’": (24.0139, 120.6181),
        "å¤§æ‘": (23.9953, 120.5486),
        "æ°¸é–": (23.9242, 120.5478),
        "ä¼¸æ¸¯": (24.1550, 120.4983),
        "ç·šè¥¿": (24.1317, 120.4686),
        "ç¦èˆˆ": (24.0406, 120.4433),
        "ç§€æ°´": (24.0314, 120.5000),
        "åŸ”å¿ƒ": (23.9539, 120.5458),
        "åŸ”é¹½": (24.0050, 120.4650),
        "å¤§åŸ": (23.8517, 120.3217),
        "èŠ³è‹‘": (23.9106, 120.3144),
        "ç«¹å¡˜": (23.8889, 120.4328),
        "ç¤¾é ­": (23.8978, 120.5839),
        "äºŒæ°´": (23.8081, 120.6189),
        "ç”°å°¾": (23.8933, 120.5233),
        "åŸ¤é ­": (23.8917, 120.4500),
        "æºªå·": (23.8519, 120.4986),
        # å—æŠ•ç¸£
        "å—æŠ•": (23.9609, 120.6971),
        "åŸ”é‡Œ": (23.9681, 120.9681),
        "è‰å±¯": (23.9742, 120.6800),
        "ç«¹å±±": (23.7569, 120.6772),
        "é›†é›†": (23.8292, 120.7847),
        "åé–“": (23.8528, 120.6889),
        "é¹¿è°·": (23.7442, 120.7542),
        "ä¸­å¯®": (23.8833, 120.7667),
        "é­šæ± ": (23.8950, 120.9386),
        "åœ‹å§“": (24.0436, 120.8597),
        "æ°´é‡Œ": (23.8178, 120.8564),
        "ä¿¡ç¾©": (23.7000, 120.8833),
        "ä»æ„›": (24.0333, 121.1333),
        # é›²æ—ç¸£
        "é›²æ—": (23.7092, 120.4313),
        "æ–—å…­": (23.7076, 120.5440),
        "æ–—å—": (23.6789, 120.4794),
        "è™å°¾": (23.7075, 120.4450),
        "è¥¿èº": (23.7975, 120.4669),
        "åœŸåº«": (23.6775, 120.3936),
        "åŒ—æ¸¯": (23.5744, 120.2994),
        "å¤å‘": (23.6433, 120.5622),
        "å¤§åŸ¤": (23.6608, 120.4344),
        "è¿æ¡": (23.7608, 120.4828),
        "æ—å…§": (23.7578, 120.6175),
        "äºŒå´™": (23.7850, 120.4158),
        "å´™èƒŒ": (23.7578, 120.3481),
        "éº¥å¯®": (23.7536, 120.2517),
        "æ±å‹¢": (23.6700, 120.2611),
        "è¤’å¿ ": (23.6939, 120.3144),
        "å°è¥¿": (23.7028, 120.1958),
        "å…ƒé•·": (23.6483, 120.3153),
        "å››æ¹–": (23.6383, 120.2328),
        "å£æ¹–": (23.5817, 120.1839),
        "æ°´æ—": (23.5719, 120.2483),
        # å˜‰ç¾©å¸‚
        "å˜‰ç¾©": (23.4801, 120.4491),
        # å˜‰ç¾©ç¸£
        "å¤ªä¿": (23.4594, 120.3328),
        "æœ´å­": (23.4650, 120.2475),
        "å¸ƒè¢‹": (23.3772, 120.1661),
        "å¤§æ—": (23.6031, 120.4719),
        "æ°‘é›„": (23.5519, 120.4294),
        "æºªå£": (23.6011, 120.3958),
        "æ–°æ¸¯": (23.5544, 120.3456),
        "å…­è…³": (23.4919, 120.2936),
        "æ±çŸ³": (23.4550, 120.1589),
        "ç¾©ç«¹": (23.3408, 120.2431),
        "é¹¿è‰": (23.4111, 120.3050),
        "æ°´ä¸Š": (23.4278, 120.3972),
        "ä¸­åŸ”": (23.4267, 120.5214),
        "ç«¹å´": (23.5228, 120.5539),
        "æ¢…å±±": (23.5844, 120.5556),
        "ç•ªè·¯": (23.4583, 120.5583),
        "å¤§åŸ”": (23.2950, 120.5933),
        "é˜¿é‡Œå±±": (23.5083, 120.7333),
        # å°å—å¸‚
        "å°å—": (22.9997, 120.2270),
        "æ–°ç‡Ÿ": (23.3106, 120.3169),
        "æ°¸åº·": (23.0264, 120.2572),
        "æ­¸ä»": (22.9697, 120.2931),
        "ä½³é‡Œ": (23.1650, 120.1772),
        "éº»è±†": (23.1808, 120.2472),
        "æ–°åŒ–": (23.0378, 120.3103),
        "å–„åŒ–": (23.1322, 120.2969),
        "æ–°å¸‚": (23.0789, 120.2950),
        "å®‰å®š": (23.1217, 120.2358),
        "å±±ä¸Š": (23.1044, 120.3494),
        "ç‰äº•": (23.1242, 120.4600),
        "æ¥ è¥¿": (23.1742, 120.4861),
        "å—åŒ–": (23.0419, 120.4769),
        "å·¦é®": (23.0569, 120.4061),
        "ä»å¾·": (22.9736, 120.2500),
        "é—œå»Ÿ": (22.9608, 120.3275),
        "é¾å´": (22.9667, 120.3667),
        "å®˜ç”°": (23.1939, 120.3183),
        "å…­ç”²": (23.2264, 120.3472),
        "å¤§å…§": (23.1167, 120.3667),
        "æŸ³ç‡Ÿ": (23.2778, 120.3128),
        "é¹½æ°´": (23.3200, 120.2661),
        "ç™½æ²³": (23.3525, 120.4317),
        "æ±å±±": (23.3253, 120.4056),
        "å¾Œå£": (23.3667, 120.3594),
        "ä¸‹ç‡Ÿ": (23.2358, 120.2650),
        "å­¸ç”²": (23.2308, 120.1772),
        "è¥¿æ¸¯": (23.1253, 120.2033),
        "ä¸ƒè‚¡": (23.1411, 120.1411),
        "å°‡è»": (23.2069, 120.1461),
        "åŒ—é–€": (23.2678, 120.1253),
        "æ–°æ¨“": (23.0017, 120.2133),
        # é«˜é›„å¸‚
        "é«˜é›„": (22.6273, 120.3014),
        "é³³å±±": (22.6278, 120.3567),
        "å²¡å±±": (22.7967, 120.2953),
        "æ——å±±": (22.8889, 120.4831),
        "ç¾æ¿ƒ": (22.8833, 120.5500),
        "æ©‹é ­": (22.7575, 120.3058),
        "ç‡•å·¢": (22.7917, 120.3611),
        "ç”°å¯®": (22.8681, 120.3603),
        "é˜¿è“®": (22.8833, 120.3258),
        "è·¯ç«¹": (22.8539, 120.2619),
        "æ¹–å…§": (22.9058, 120.2039),
        "èŒ„è£": (22.9061, 120.1850),
        "æ°¸å®‰": (22.8189, 120.2228),
        "å½Œé™€": (22.7828, 120.2494),
        "æ¢“å®˜": (22.7556, 120.2636),
        "å¤§ç¤¾": (22.7306, 120.3461),
        "å¤§æ¨¹": (22.6917, 120.4300),
        "å¤§å¯®": (22.5653, 120.3950),
        "æ—åœ’": (22.5031, 120.4119),
        "ä»æ­¦": (22.7017, 120.3467),
        "é³¥æ¾": (22.6622, 120.3644),
        "å°æ¸¯": (22.5650, 120.3367),
        "å‰é®": (22.6056, 120.3103),
        "æ——æ´¥": (22.5831, 120.2633),
        "é¼“å±±": (22.6556, 120.2806),
        "é¹½åŸ•": (22.6239, 120.2856),
        "å·¦ç‡Ÿ": (22.6778, 120.2942),
        "æ¥ æ¢“": (22.7333, 120.3281),
        "ä¸‰æ°‘": (22.6408, 120.3167),
        "è‹“é›…": (22.6231, 120.3100),
        "æ–°èˆˆ": (22.6281, 120.3061),
        "å‰é‡‘": (22.6308, 120.2939),
        "å…§é–€": (22.9519, 120.4656),
        "æ‰æ—": (22.9667, 120.5500),
        "ç”²ä»™": (23.0833, 120.5833),
        "å…­é¾œ": (22.9989, 120.6308),
        "èŒ‚æ—": (22.8867, 120.6581),
        "æ¡ƒæº": (23.1542, 120.7667),
        "é‚£ç‘ªå¤": (23.2333, 120.7000),
        # å±æ±ç¸£
        "å±æ±": (22.6820, 120.4881),
        "æ½®å·": (22.5506, 120.5425),
        "æ±æ¸¯": (22.4653, 120.4531),
        "æ†æ˜¥": (22.0050, 120.7467),
        "è¬ä¸¹": (22.5878, 120.4839),
        "é•·æ²»": (22.6778, 120.5194),
        "éºŸæ´›": (22.6508, 120.5275),
        "ä¹å¦‚": (22.7408, 120.4881),
        "é‡Œæ¸¯": (22.7778, 120.4944),
        "é¹½åŸ”": (22.7542, 120.5681),
        "é«˜æ¨¹": (22.8258, 120.5981),
        "è¬å·’": (22.5708, 120.5650),
        "å…§åŸ”": (22.6119, 120.5650),
        "ç«¹ç”°": (22.5850, 120.5417),
        "æ–°åŸ¤": (22.4697, 120.5500),
        "æ‹å¯®": (22.3653, 120.5933),
        "æ–°åœ’": (22.5417, 120.4667),
        "å´é ‚": (22.5056, 120.5119),
        "æ—é‚Š": (22.4331, 120.5228),
        "å—å·": (22.4906, 120.5089),
        "ä½³å†¬": (22.4186, 120.5511),
        "ç‰çƒ": (22.3397, 120.3714),
        "è»ŠåŸ": (22.0742, 120.7089),
        "æ»¿å·": (22.0167, 120.8433),
        "æ‹å±±": (22.2617, 120.6572),
        "ä¸‰åœ°é–€": (22.7133, 120.6533),
        "éœ§å°": (22.7417, 120.7333),
        "ç‘ªå®¶": (22.7083, 120.6167),
        "æ³°æ­¦": (22.6000, 120.6333),
        "ä¾†ç¾©": (22.5333, 120.6667),
        "æ˜¥æ—¥": (22.3750, 120.6333),
        "ç…å­": (22.2167, 120.7167),
        "ç‰¡ä¸¹": (22.1333, 120.7833),
        # å®œè˜­ç¸£
        "å®œè˜­": (24.7022, 121.7378),
        "ç¾…æ±": (24.6769, 121.7714),
        "è˜‡æ¾³": (24.5958, 121.8542),
        "é ­åŸ": (24.8578, 121.8225),
        "ç¤æºª": (24.8261, 121.7711),
        "å£¯åœ": (24.7372, 121.7828),
        "å“¡å±±": (24.7400, 121.7050),
        "å†¬å±±": (24.6378, 121.7931),
        "äº”çµ": (24.6850, 121.7989),
        "ä¸‰æ˜Ÿ": (24.6619, 121.6433),
        "å¤§åŒ": (24.5667, 121.4167),
        "å—æ¾³": (24.4667, 121.8000),
        # èŠ±è“®ç¸£
        "èŠ±è“®": (23.9871, 121.6015),
        "é³³æ—": (23.7486, 121.4522),
        "ç‰é‡Œ": (23.3344, 121.3128),
        "æ–°åŸ": (24.1289, 121.6414),
        "å‰å®‰": (23.9742, 121.5800),
        "å£½è±": (23.8653, 121.5069),
        "å…‰å¾©": (23.6667, 121.4167),
        "è±æ¿±": (23.5981, 121.5133),
        "ç‘ç©—": (23.4986, 121.3778),
        "å¯Œé‡Œ": (23.1806, 121.2500),
        "ç§€æ—": (24.1500, 121.4333),
        "è¬æ¦®": (23.7167, 121.4000),
        "å“æºª": (23.3500, 121.2667),
        # å°æ±ç¸£
        "å°æ±": (22.7583, 121.1444),
        "æˆåŠŸ": (23.0975, 121.3694),
        "é—œå±±": (23.0450, 121.1619),
        "å‘å—": (22.7667, 121.1000),
        "é¹¿é‡": (22.9092, 121.1244),
        "æ± ä¸Š": (23.1222, 121.2186),
        "æ±æ²³": (23.2000, 121.3000),
        "é•·æ¿±": (23.3167, 121.4500),
        "å¤ªéº»é‡Œ": (22.6131, 120.9908),
        "å¤§æ­¦": (22.3417, 120.8992),
        "ç¶ å³¶": (22.6667, 121.4833),
        "æµ·ç«¯": (23.1000, 121.1667),
        "å»¶å¹³": (22.9667, 121.1167),
        "é‡‘å³°": (22.5833, 120.9500),
        "é”ä»": (22.2833, 120.8667),
        "è˜­å¶¼": (22.0500, 121.5333),
        # æ¾æ¹–ç¸£
        "æ¾æ¹–": (23.5711, 119.5794),
        "é¦¬å…¬": (23.5667, 119.5833),
        "æ¹–è¥¿": (23.5833, 119.6500),
        "ç™½æ²™": (23.6667, 119.6000),
        "è¥¿å¶¼": (23.6000, 119.5000),
        "æœ›å®‰": (23.3667, 119.5000),
        "ä¸ƒç¾": (23.2000, 119.4333),
        # é‡‘é–€ç¸£
        "é‡‘é–€": (24.4492, 118.3765),
        "é‡‘åŸ": (24.4333, 118.3167),
        "é‡‘æ¹–": (24.4333, 118.4167),
        "é‡‘æ²™": (24.4833, 118.4167),
        "é‡‘å¯§": (24.4500, 118.3333),
        "çƒˆå¶¼": (24.4333, 118.2333),
        "çƒåµ": (24.9833, 119.4500),
        # é€£æ±Ÿç¸£ï¼ˆé¦¬ç¥–ï¼‰
        "é€£æ±Ÿ": (26.1508, 119.9511),
        "å—ç«¿": (26.1500, 119.9333),
        "åŒ—ç«¿": (26.2167, 120.0000),
        "è’å…‰": (25.9667, 119.9333),
        "æ±å¼•": (26.3667, 120.5000),
    }

    return taiwan_cities.get(city_name)


def get_cwa_location_name(city_name: str) -> Optional[str]:
    """
    å°‡åŸå¸‚åç¨±å°æ‡‰åˆ°ä¸­å¤®æ°£è±¡ç½²çš„è¡Œæ”¿å€ä»£ç¢¼
    """
    # ä¸­å¤®æ°£è±¡ç½²ç¸£å¸‚åç¨±å°ç…§è¡¨
    cwa_location_map = {
        # æ–°åŒ—å¸‚
        "æ³°å±±": "æ–°åŒ—å¸‚",
        "æ¿æ©‹": "æ–°åŒ—å¸‚",
        "æ–°åŒ—": "æ–°åŒ—å¸‚",
        "è¬è¯": "è‡ºåŒ—å¸‚",
        "æ¨¹æ—": "æ–°åŒ—å¸‚",
        "ä¸‰é‡": "æ–°åŒ—å¸‚",
        "æ–°èŠ": "æ–°åŒ—å¸‚",
        "ä¸­å’Œ": "æ–°åŒ—å¸‚",
        "æ°¸å’Œ": "æ–°åŒ—å¸‚",
        "åœŸåŸ": "æ–°åŒ—å¸‚",
        "è˜†æ´²": "æ–°åŒ—å¸‚",
        "æ±æ­¢": "æ–°åŒ—å¸‚",
        "æ·¡æ°´": "æ–°åŒ—å¸‚",
        "ç‘èŠ³": "æ–°åŒ—å¸‚",
        "ä¸‰å³½": "æ–°åŒ—å¸‚",
        "é¶¯æ­Œ": "æ–°åŒ—å¸‚",
        "æ–°åº—": "æ–°åŒ—å¸‚",
        "æ·±å‘": "æ–°åŒ—å¸‚",
        "çŸ³ç¢‡": "æ–°åŒ—å¸‚",
        "åªæ—": "æ–°åŒ—å¸‚",
        "çƒä¾†": "æ–°åŒ—å¸‚",
        "äº”è‚¡": "æ–°åŒ—å¸‚",
        "å…«é‡Œ": "æ–°åŒ—å¸‚",
        "æ—å£": "æ–°åŒ—å¸‚",
        "ä¸‰èŠ": "æ–°åŒ—å¸‚",
        "çŸ³é–€": "æ–°åŒ—å¸‚",
        "é‡‘å±±": "æ–°åŒ—å¸‚",
        "è¬é‡Œ": "æ–°åŒ—å¸‚",
        "å¹³æºª": "æ–°åŒ—å¸‚",
        "é›™æºª": "æ–°åŒ—å¸‚",
        "è²¢å¯®": "æ–°åŒ—å¸‚",
        # å°åŒ—å¸‚
        "å°åŒ—": "è‡ºåŒ—å¸‚",
        "è‡ºåŒ—": "è‡ºåŒ—å¸‚",
        "å£«æ—": "è‡ºåŒ—å¸‚",
        "åŒ—æŠ•": "è‡ºåŒ—å¸‚",
        "å…§æ¹–": "è‡ºåŒ—å¸‚",
        "å—æ¸¯": "è‡ºåŒ—å¸‚",
        "æ¾å±±": "è‡ºåŒ—å¸‚",
        "ä¿¡ç¾©": "è‡ºåŒ—å¸‚",
        "å¤§å®‰": "è‡ºåŒ—å¸‚",
        "ä¸­å±±": "è‡ºåŒ—å¸‚",
        "ä¸­æ­£": "è‡ºåŒ—å¸‚",
        "å¤§åŒ": "è‡ºåŒ—å¸‚",
        "æ–‡å±±": "è‡ºåŒ—å¸‚",
        # åŸºéš†å¸‚
        "åŸºéš†": "åŸºéš†å¸‚",
        # æ¡ƒåœ’å¸‚
        "æ¡ƒåœ’": "æ¡ƒåœ’å¸‚",
        "ä¸­å£¢": "æ¡ƒåœ’å¸‚",
        "å¹³é®": "æ¡ƒåœ’å¸‚",
        "å…«å¾·": "æ¡ƒåœ’å¸‚",
        "æ¥Šæ¢…": "æ¡ƒåœ’å¸‚",
        "è˜†ç«¹": "æ¡ƒåœ’å¸‚",
        "å¤§æºª": "æ¡ƒåœ’å¸‚",
        "é¾æ½­": "æ¡ƒåœ’å¸‚",
        "é¾œå±±": "æ¡ƒåœ’å¸‚",
        "å¤§åœ’": "æ¡ƒåœ’å¸‚",
        "è§€éŸ³": "æ¡ƒåœ’å¸‚",
        "æ–°å±‹": "æ¡ƒåœ’å¸‚",
        "å¾©èˆˆ": "æ¡ƒåœ’å¸‚",
        # æ–°ç«¹å¸‚/ç¸£
        "æ–°ç«¹": "æ–°ç«¹å¸‚",
        "ç«¹åŒ—": "æ–°ç«¹ç¸£",
        "ç«¹æ±": "æ–°ç«¹ç¸£",
        "æ–°åŸ”": "æ–°ç«¹ç¸£",
        "é—œè¥¿": "æ–°ç«¹ç¸£",
        "æ¹–å£": "æ–°ç«¹ç¸£",
        "æ–°è±": "æ–°ç«¹ç¸£",
        "å³¨çœ‰": "æ–°ç«¹ç¸£",
        "å¯¶å±±": "æ–°ç«¹ç¸£",
        "åŒ—åŸ”": "æ–°ç«¹ç¸£",
        "èŠæ—": "æ–°ç«¹ç¸£",
        "æ©«å±±": "æ–°ç«¹ç¸£",
        "å°–çŸ³": "æ–°ç«¹ç¸£",
        "äº”å³°": "æ–°ç«¹ç¸£",
        # è‹—æ —ç¸£
        "è‹—æ —": "è‹—æ —ç¸£",
        "é ­ä»½": "è‹—æ —ç¸£",
        "ç«¹å—": "è‹—æ —ç¸£",
        "è‹‘è£¡": "è‹—æ —ç¸£",
        "é€šéœ„": "è‹—æ —ç¸£",
        "å¾Œé¾": "è‹—æ —ç¸£",
        "å“è˜­": "è‹—æ —ç¸£",
        "å¤§æ¹–": "è‹—æ —ç¸£",
        "å…¬é¤¨": "è‹—æ —ç¸£",
        "éŠ…é‘¼": "è‹—æ —ç¸£",
        "å—åº„": "è‹—æ —ç¸£",
        "é ­å±‹": "è‹—æ —ç¸£",
        "ä¸‰ç¾©": "è‹—æ —ç¸£",
        "è¥¿æ¹–": "è‹—æ —ç¸£",
        "é€ æ©‹": "è‹—æ —ç¸£",
        "ä¸‰ç£": "è‹—æ —ç¸£",
        "ç…æ½­": "è‹—æ —ç¸£",
        "æ³°å®‰": "è‹—æ —ç¸£",
        # å°ä¸­å¸‚
        "å°ä¸­": "è‡ºä¸­å¸‚",
        "è‡ºä¸­": "è‡ºä¸­å¸‚",
        "è±åŸ": "è‡ºä¸­å¸‚",
        "å¤§é‡Œ": "è‡ºä¸­å¸‚",
        "å¤ªå¹³": "è‡ºä¸­å¸‚",
        "æ¸…æ°´": "è‡ºä¸­å¸‚",
        "æ²™é¹¿": "è‡ºä¸­å¸‚",
        "å¤§ç”²": "è‡ºä¸­å¸‚",
        "æ±å‹¢": "è‡ºä¸­å¸‚",
        "æ¢§æ£²": "è‡ºä¸­å¸‚",
        "çƒæ—¥": "è‡ºä¸­å¸‚",
        "ç¥å²¡": "è‡ºä¸­å¸‚",
        "å¤§è‚š": "è‡ºä¸­å¸‚",
        "å¤§é›…": "è‡ºä¸­å¸‚",
        "åé‡Œ": "è‡ºä¸­å¸‚",
        "éœ§å³°": "è‡ºä¸­å¸‚",
        "æ½­å­": "è‡ºä¸­å¸‚",
        "é¾äº•": "è‡ºä¸­å¸‚",
        "å¤–åŸ”": "è‡ºä¸­å¸‚",
        "å’Œå¹³": "è‡ºä¸­å¸‚",
        "çŸ³å²¡": "è‡ºä¸­å¸‚",
        "æ–°ç¤¾": "è‡ºä¸­å¸‚",
        # å½°åŒ–ç¸£
        "å½°åŒ–": "å½°åŒ–ç¸£",
        "å“¡æ—": "å½°åŒ–ç¸£",
        "å’Œç¾": "å½°åŒ–ç¸£",
        "é¹¿æ¸¯": "å½°åŒ–ç¸£",
        "æºªæ¹–": "å½°åŒ–ç¸£",
        "äºŒæ—": "å½°åŒ–ç¸£",
        "ç”°ä¸­": "å½°åŒ–ç¸£",
        "åŒ—æ–—": "å½°åŒ–ç¸£",
        # å—æŠ•ç¸£
        "å—æŠ•": "å—æŠ•ç¸£",
        "åŸ”é‡Œ": "å—æŠ•ç¸£",
        "è‰å±¯": "å—æŠ•ç¸£",
        "ç«¹å±±": "å—æŠ•ç¸£",
        "é›†é›†": "å—æŠ•ç¸£",
        "åé–“": "å—æŠ•ç¸£",
        "é¹¿è°·": "å—æŠ•ç¸£",
        "ä¸­å¯®": "å—æŠ•ç¸£",
        "é­šæ± ": "å—æŠ•ç¸£",
        "åœ‹å§“": "å—æŠ•ç¸£",
        "æ°´é‡Œ": "å—æŠ•ç¸£",
        "ä»æ„›": "å—æŠ•ç¸£",
        # é›²æ—ç¸£
        "é›²æ—": "é›²æ—ç¸£",
        "æ–—å…­": "é›²æ—ç¸£",
        "æ–—å—": "é›²æ—ç¸£",
        "è™å°¾": "é›²æ—ç¸£",
        "è¥¿èº": "é›²æ—ç¸£",
        "åœŸåº«": "é›²æ—ç¸£",
        "åŒ—æ¸¯": "é›²æ—ç¸£",
        "å¤å‘": "é›²æ—ç¸£",
        # å˜‰ç¾©å¸‚/ç¸£
        "å˜‰ç¾©": "å˜‰ç¾©å¸‚",
        "å¤ªä¿": "å˜‰ç¾©ç¸£",
        "æœ´å­": "å˜‰ç¾©ç¸£",
        "å¸ƒè¢‹": "å˜‰ç¾©ç¸£",
        "å¤§æ—": "å˜‰ç¾©ç¸£",
        "æ°‘é›„": "å˜‰ç¾©ç¸£",
        "æºªå£": "å˜‰ç¾©ç¸£",
        "æ–°æ¸¯": "å˜‰ç¾©ç¸£",
        "å…­è…³": "å˜‰ç¾©ç¸£",
        "æ±çŸ³": "å˜‰ç¾©ç¸£",
        "ç¾©ç«¹": "å˜‰ç¾©ç¸£",
        "é¹¿è‰": "å˜‰ç¾©ç¸£",
        "æ°´ä¸Š": "å˜‰ç¾©ç¸£",
        "ä¸­åŸ”": "å˜‰ç¾©ç¸£",
        "ç«¹å´": "å˜‰ç¾©ç¸£",
        "æ¢…å±±": "å˜‰ç¾©ç¸£",
        "ç•ªè·¯": "å˜‰ç¾©ç¸£",
        "å¤§åŸ”": "å˜‰ç¾©ç¸£",
        "é˜¿é‡Œå±±": "å˜‰ç¾©ç¸£",
        # å°å—å¸‚
        "å°å—": "è‡ºå—å¸‚",
        "è‡ºå—": "è‡ºå—å¸‚",
        "æ–°ç‡Ÿ": "è‡ºå—å¸‚",
        "æ°¸åº·": "è‡ºå—å¸‚",
        "æ­¸ä»": "è‡ºå—å¸‚",
        "ä½³é‡Œ": "è‡ºå—å¸‚",
        "éº»è±†": "è‡ºå—å¸‚",
        "æ–°åŒ–": "è‡ºå—å¸‚",
        "å–„åŒ–": "è‡ºå—å¸‚",
        "æ–°å¸‚": "è‡ºå—å¸‚",
        "å®‰å®š": "è‡ºå—å¸‚",
        "ä»å¾·": "è‡ºå—å¸‚",
        "é—œå»Ÿ": "è‡ºå—å¸‚",
        "é¾å´": "è‡ºå—å¸‚",
        "å®˜ç”°": "è‡ºå—å¸‚",
        "å…­ç”²": "è‡ºå—å¸‚",
        "å¤§å…§": "è‡ºå—å¸‚",
        "æŸ³ç‡Ÿ": "è‡ºå—å¸‚",
        "é¹½æ°´": "è‡ºå—å¸‚",
        "ç™½æ²³": "è‡ºå—å¸‚",
        "æ±å±±": "è‡ºå—å¸‚",
        "å¾Œå£": "è‡ºå—å¸‚",
        "ä¸‹ç‡Ÿ": "è‡ºå—å¸‚",
        "å­¸ç”²": "è‡ºå—å¸‚",
        "è¥¿æ¸¯": "è‡ºå—å¸‚",
        "ä¸ƒè‚¡": "è‡ºå—å¸‚",
        "å°‡è»": "è‡ºå—å¸‚",
        "åŒ—é–€": "è‡ºå—å¸‚",
        # é«˜é›„å¸‚
        "é«˜é›„": "é«˜é›„å¸‚",
        "é³³å±±": "é«˜é›„å¸‚",
        "å²¡å±±": "é«˜é›„å¸‚",
        "æ——å±±": "é«˜é›„å¸‚",
        "ç¾æ¿ƒ": "é«˜é›„å¸‚",
        "æ©‹é ­": "é«˜é›„å¸‚",
        "ç‡•å·¢": "é«˜é›„å¸‚",
        "ç”°å¯®": "é«˜é›„å¸‚",
        "é˜¿è“®": "é«˜é›„å¸‚",
        "è·¯ç«¹": "é«˜é›„å¸‚",
        "æ¹–å…§": "é«˜é›„å¸‚",
        "èŒ„è£": "é«˜é›„å¸‚",
        "æ°¸å®‰": "é«˜é›„å¸‚",
        "å½Œé™€": "é«˜é›„å¸‚",
        "æ¢“å®˜": "é«˜é›„å¸‚",
        "å¤§ç¤¾": "é«˜é›„å¸‚",
        "å¤§æ¨¹": "é«˜é›„å¸‚",
        "å¤§å¯®": "é«˜é›„å¸‚",
        "æ—åœ’": "é«˜é›„å¸‚",
        "ä»æ­¦": "é«˜é›„å¸‚",
        "é³¥æ¾": "é«˜é›„å¸‚",
        "å°æ¸¯": "é«˜é›„å¸‚",
        "å‰é®": "é«˜é›„å¸‚",
        "æ——æ´¥": "é«˜é›„å¸‚",
        "é¼“å±±": "é«˜é›„å¸‚",
        "é¹½åŸ•": "é«˜é›„å¸‚",
        "å·¦ç‡Ÿ": "é«˜é›„å¸‚",
        "æ¥ æ¢“": "é«˜é›„å¸‚",
        "ä¸‰æ°‘": "é«˜é›„å¸‚",
        "è‹“é›…": "é«˜é›„å¸‚",
        "æ–°èˆˆ": "é«˜é›„å¸‚",
        "å‰é‡‘": "é«˜é›„å¸‚",
        "å…§é–€": "é«˜é›„å¸‚",
        "æ‰æ—": "é«˜é›„å¸‚",
        "ç”²ä»™": "é«˜é›„å¸‚",
        "å…­é¾œ": "é«˜é›„å¸‚",
        "èŒ‚æ—": "é«˜é›„å¸‚",
        "æ¡ƒæº": "é«˜é›„å¸‚",
        "é‚£ç‘ªå¤": "é«˜é›„å¸‚",
        # å±æ±ç¸£
        "å±æ±": "å±æ±ç¸£",
        "æ½®å·": "å±æ±ç¸£",
        "æ±æ¸¯": "å±æ±ç¸£",
        "æ†æ˜¥": "å±æ±ç¸£",
        "è¬ä¸¹": "å±æ±ç¸£",
        "é•·æ²»": "å±æ±ç¸£",
        "éºŸæ´›": "å±æ±ç¸£",
        "ä¹å¦‚": "å±æ±ç¸£",
        "é‡Œæ¸¯": "å±æ±ç¸£",
        "é¹½åŸ”": "å±æ±ç¸£",
        "é«˜æ¨¹": "å±æ±ç¸£",
        "è¬å·’": "å±æ±ç¸£",
        "å…§åŸ”": "å±æ±ç¸£",
        "ç«¹ç”°": "å±æ±ç¸£",
        "æ–°åŸ¤": "å±æ±ç¸£",
        "æ‹å¯®": "å±æ±ç¸£",
        # å®œè˜­ç¸£
        "å®œè˜­": "å®œè˜­ç¸£",
        "ç¾…æ±": "å®œè˜­ç¸£",
        "è˜‡æ¾³": "å®œè˜­ç¸£",
        "é ­åŸ": "å®œè˜­ç¸£",
        "ç¤æºª": "å®œè˜­ç¸£",
        "å£¯åœ": "å®œè˜­ç¸£",
        "å“¡å±±": "å®œè˜­ç¸£",
        "å†¬å±±": "å®œè˜­ç¸£",
        "äº”çµ": "å®œè˜­ç¸£",
        "ä¸‰æ˜Ÿ": "å®œè˜­ç¸£",
        "å¤§åŒ": "å®œè˜­ç¸£",
        "å—æ¾³": "å®œè˜­ç¸£",
        # èŠ±è“®ç¸£
        "èŠ±è“®": "èŠ±è“®ç¸£",
        "é³³æ—": "èŠ±è“®ç¸£",
        "ç‰é‡Œ": "èŠ±è“®ç¸£",
        "æ–°åŸ": "èŠ±è“®ç¸£",
        "å‰å®‰": "èŠ±è“®ç¸£",
        "å£½è±": "èŠ±è“®ç¸£",
        "å…‰å¾©": "èŠ±è“®ç¸£",
        "è±æ¿±": "èŠ±è“®ç¸£",
        "ç‘ç©—": "èŠ±è“®ç¸£",
        "å¯Œé‡Œ": "èŠ±è“®ç¸£",
        "ç§€æ—": "èŠ±è“®ç¸£",
        "è¬æ¦®": "èŠ±è“®ç¸£",
        "å“æºª": "èŠ±è“®ç¸£",
        # å°æ±ç¸£
        "å°æ±": "è‡ºæ±ç¸£",
        "è‡ºæ±": "è‡ºæ±ç¸£",
        "æˆåŠŸ": "è‡ºæ±ç¸£",
        "é—œå±±": "è‡ºæ±ç¸£",
        "å‘å—": "è‡ºæ±ç¸£",
        "é¹¿é‡": "è‡ºæ±ç¸£",
        "æ± ä¸Š": "è‡ºæ±ç¸£",
        "æ±æ²³": "è‡ºæ±ç¸£",
        "é•·æ¿±": "è‡ºæ±ç¸£",
        "å¤ªéº»é‡Œ": "è‡ºæ±ç¸£",
        "å¤§æ­¦": "è‡ºæ±ç¸£",
        "ç¶ å³¶": "è‡ºæ±ç¸£",
        # æ¾æ¹–ç¸£
        "æ¾æ¹–": "æ¾æ¹–ç¸£",
        "é¦¬å…¬": "æ¾æ¹–ç¸£",
        "æ¹–è¥¿": "æ¾æ¹–ç¸£",
        "ç™½æ²™": "æ¾æ¹–ç¸£",
        "è¥¿å¶¼": "æ¾æ¹–ç¸£",
        "æœ›å®‰": "æ¾æ¹–ç¸£",
        "ä¸ƒç¾": "æ¾æ¹–ç¸£",
        # é‡‘é–€ç¸£
        "é‡‘é–€": "é‡‘é–€ç¸£",
        "é‡‘åŸ": "é‡‘é–€ç¸£",
        "é‡‘æ¹–": "é‡‘é–€ç¸£",
        "é‡‘æ²™": "é‡‘é–€ç¸£",
        "é‡‘å¯§": "é‡‘é–€ç¸£",
        "çƒˆå¶¼": "é‡‘é–€ç¸£",
        # é€£æ±Ÿç¸£ï¼ˆé¦¬ç¥–ï¼‰
        "é€£æ±Ÿ": "é€£æ±Ÿç¸£",
        "å—ç«¿": "é€£æ±Ÿç¸£",
        "åŒ—ç«¿": "é€£æ±Ÿç¸£",
        "è’å…‰": "é€£æ±Ÿç¸£",
        "æ±å¼•": "é€£æ±Ÿç¸£",
    }

    return cwa_location_map.get(city_name, city_name)


def get_cwa_weather_forecast(city_name: str, days: int = 7) -> Optional[List[Dict]]:
    """
    ä½¿ç”¨ä¸­å¤®æ°£è±¡ç½² API å–å¾—å¤©æ°£é å ±ï¼ˆå°ç£å°ˆç”¨ï¼Œæœ€æº–ç¢ºï¼‰

    Args:
        city_name: åŸå¸‚åç¨±
        days: é å ±å¤©æ•¸ï¼ˆ1 å¤©æˆ– 7 å¤©ï¼‰

    Returns:
        å¤©æ°£è³‡è¨Šåˆ—è¡¨
    """
    if not CWA_API_KEY:
        print("âš ï¸ æœªè¨­å®šä¸­å¤®æ°£è±¡ç½² API é‡‘é‘°ï¼Œè«‹è‡³ https://opendata.cwa.gov.tw/ ç”³è«‹")
        return None

    location_name = get_cwa_location_name(city_name)
    if not location_name:
        print(f"âŒ æ‰¾ä¸åˆ° {city_name} çš„å°æ‡‰ç¸£å¸‚")
        return None

    try:
        # æ ¹æ“šå¤©æ•¸é¸æ“‡ä¸åŒçš„ API
        if days <= 2:
            # ä½¿ç”¨ã€Œä¸€èˆ¬å¤©æ°£é å ±-ä»Šæ˜ 36 å°æ™‚å¤©æ°£é å ±ã€
            api_id = "F-C0032-001"
        else:
            # ä½¿ç”¨ã€Œä¸€èˆ¬å¤©æ°£é å ±-æœªä¾†ä¸€é€±å¤©æ°£é å ±ã€
            api_id = "F-D0047-091"  # é€™å€‹ API æä¾› 7 å¤©é å ±

        url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/{api_id}"
        params = {
            "Authorization": CWA_API_KEY,
            "locationName": location_name,
        }

        response = requests.get(url, params=params, timeout=15)
        response.raise_for_status()
        data = response.json()

        if data.get("success") != "true":
            raise Exception(f"API å›æ‡‰å¤±æ•—: {data.get('message', 'æœªçŸ¥éŒ¯èª¤')}")

        # è§£æå¤©æ°£è³‡æ–™
        weather_list = []

        if api_id == "F-C0032-001":
            # 36 å°æ™‚é å ±æ ¼å¼
            weather_list = parse_cwa_36h_data(data, days)
        else:
            # ä¸€é€±é å ±æ ¼å¼
            weather_list = parse_cwa_7d_data(data, days)

        return weather_list[:days]

    except requests.exceptions.RequestException as e:
        print(f"âŒ ä¸­å¤®æ°£è±¡ç½² API è«‹æ±‚å¤±æ•—ï¼š{e}")
        return None
    except Exception as e:
        print(f"âŒ è™•ç†æ°£è±¡è³‡æ–™å¤±æ•—ï¼š{e}")
        return None


def parse_cwa_36h_data(data: dict, days: int) -> List[Dict]:
    """è§£æä¸­å¤®æ°£è±¡ç½² 36 å°æ™‚é å ±è³‡æ–™"""
    weather_list = []

    try:
        locations = data["records"]["location"]
        if not locations:
            return []

        weather_elements = locations[0]["weatherElement"]

        # æ‰¾å‡ºå„é …è³‡æ–™
        wx_element = next(
            (e for e in weather_elements if e["elementName"] == "Wx"), None
        )
        pop_element = next(
            (e for e in weather_elements if e["elementName"] == "PoP"), None
        )
        min_t_element = next(
            (e for e in weather_elements if e["elementName"] == "MinT"), None
        )
        max_t_element = next(
            (e for e in weather_elements if e["elementName"] == "MaxT"), None
        )

        if not all([wx_element, pop_element, min_t_element, max_t_element]):
            return []

        # æ•´ç†æ¯å€‹æ™‚æ®µçš„è³‡æ–™
        time_periods = len(wx_element["time"])
        daily_data = {}

        for i in range(time_periods):
            start_time = wx_element["time"][i]["startTime"]
            date_str = start_time.split(" ")[0]

            if date_str not in daily_data:
                daily_data[date_str] = {
                    "temps_max": [],
                    "temps_min": [],
                    "descriptions": [],
                    "rain_probs": [],
                }

            daily_data[date_str]["descriptions"].append(
                wx_element["time"][i]["parameter"]["parameterName"]
            )
            daily_data[date_str]["rain_probs"].append(
                float(pop_element["time"][i]["parameter"]["parameterName"])
            )
            daily_data[date_str]["temps_min"].append(
                float(min_t_element["time"][i]["parameter"]["parameterName"])
            )
            daily_data[date_str]["temps_max"].append(
                float(max_t_element["time"][i]["parameter"]["parameterName"])
            )

        # æ•´ç†æˆæ¯æ—¥è³‡æ–™
        for date_str in sorted(daily_data.keys()):
            day_info = daily_data[date_str]
            weather_list.append(
                {
                    "date": date_str,
                    "temp_max": max(day_info["temps_max"]),
                    "temp_min": min(day_info["temps_min"]),
                    "description": day_info["descriptions"][0],
                    "rain_probability": max(day_info["rain_probs"]),
                }
            )

        return weather_list

    except Exception as e:
        print(f"è§£æ 36 å°æ™‚è³‡æ–™å¤±æ•—ï¼š{e}")
        return []


def parse_cwa_7d_data(data: dict, days: int) -> List[Dict]:
    """è§£æä¸­å¤®æ°£è±¡ç½²ä¸€é€±é å ±è³‡æ–™"""
    weather_list = []

    try:
        locations = data["records"]["locations"][0]["location"]
        if not locations:
            return []

        # å–å¾—ç¬¬ä¸€å€‹ç¬¦åˆçš„åœ°é»
        location_data = locations[0]
        weather_elements = location_data["weatherElement"]

        # æ‰¾å‡ºå„é …è³‡æ–™
        wx_element = next(
            (e for e in weather_elements if e["elementName"] == "WeatherDescription"),
            None,
        )
        if not wx_element:
            wx_element = next(
                (e for e in weather_elements if e["elementName"] == "Wx"), None
            )

        t_element = next((e for e in weather_elements if e["elementName"] == "T"), None)
        pop_element = next(
            (e for e in weather_elements if e["elementName"] == "PoP12h"), None
        )

        if not wx_element or not t_element:
            print("æ‰¾ä¸åˆ°å¿…è¦çš„å¤©æ°£å…ƒç´ ")
            return []

        # æ•´ç†è³‡æ–™
        daily_data = {}

        for time_data in t_element["time"]:
            date_str = time_data["startTime"].split(" ")[0]
            temp = float(time_data["elementValue"][0]["value"])

            if date_str not in daily_data:
                daily_data[date_str] = {
                    "temps": [],
                    "description": "",
                    "rain_prob": 0,
                }

            daily_data[date_str]["temps"].append(temp)

        # åŠ å…¥å¤©æ°£æè¿°
        for time_data in wx_element["time"]:
            date_str = time_data["startTime"].split(" ")[0]
            if date_str in daily_data and not daily_data[date_str]["description"]:
                daily_data[date_str]["description"] = time_data["elementValue"][0][
                    "value"
                ]

        # åŠ å…¥é™é›¨æ©Ÿç‡
        if pop_element:
            for time_data in pop_element["time"]:
                date_str = time_data["startTime"].split(" ")[0]
                if date_str in daily_data:
                    value = time_data["elementValue"][0]["value"]
                    if value and value != " ":
                        daily_data[date_str]["rain_prob"] = max(
                            daily_data[date_str]["rain_prob"], float(value)
                        )

        # æ•´ç†æˆæ¨™æº–æ ¼å¼
        for date_str in sorted(daily_data.keys())[:days]:
            day_info = daily_data[date_str]
            if day_info["temps"]:
                weather_list.append(
                    {
                        "date": date_str,
                        "temp_max": max(day_info["temps"]),
                        "temp_min": min(day_info["temps"]),
                        "description": day_info["description"] or "å¤šé›²",
                        "rain_probability": day_info["rain_prob"],
                    }
                )

        return weather_list

    except Exception as e:
        print(f"è§£æä¸€é€±è³‡æ–™å¤±æ•—ï¼š{e}")
        import traceback

        traceback.print_exc()
        return []


def get_weather_forecast(city_name: str, days: int = 7) -> Optional[List[Dict]]:
    """
    å–å¾—æŒ‡å®šåŸå¸‚çš„å¤©æ°£é å ±

    Args:
        city_name: åŸå¸‚åç¨±
        days: é å ±å¤©æ•¸ï¼ˆæœ€å¤š 7 å¤©ï¼‰

    Returns:
        å¤©æ°£è³‡è¨Šåˆ—è¡¨ï¼Œæ¯å€‹å…ƒç´ åŒ…å«ï¼š
        - date: æ—¥æœŸ
        - temp_max: æœ€é«˜æº«ï¼ˆÂ°Cï¼‰
        - temp_min: æœ€ä½æº«ï¼ˆÂ°Cï¼‰
        - description: å¤©æ°£æè¿°
        - rain_probability: é™é›¨æ©Ÿç‡ï¼ˆ%ï¼‰
    """
    # é™åˆ¶æœ€å¤š 7 å¤©
    if days > 7:
        days = 7
        print(f"âš ï¸ å¤©æ°£é å ±æœ€å¤šæä¾› 7 å¤©")

    # å„ªå…ˆä½¿ç”¨ä¸­å¤®æ°£è±¡ç½² APIï¼ˆå°ç£åœ°å€æœ€æº–ç¢ºï¼‰
    if CWA_API_KEY:
        cwa_result = get_cwa_weather_forecast(city_name, days)
        if cwa_result:
            print(f"âœ… ä½¿ç”¨ä¸­å¤®æ°£è±¡ç½²è³‡æ–™")
            return cwa_result
        else:
            print("âš ï¸ ä¸­å¤®æ°£è±¡ç½² API å¤±æ•—ï¼Œæ”¹ç”¨ OpenWeatherMap")

    # é™ç´šä½¿ç”¨ OpenWeatherMap
    if not OPENWEATHER_API_KEY:
        # å¦‚æœæ²’æœ‰ API Keyï¼Œè¿”å›æ¨¡æ“¬è³‡æ–™
        print("âš ï¸ ç„¡å¯ç”¨ APIï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™")
        return get_mock_weather(city_name, days)

    coords = get_coordinates(city_name)
    if not coords:
        return None

    lat, lon = coords

    try:
        # ä½¿ç”¨ OpenWeatherMap One Call API 3.0 (å…è²»ç‰ˆ)
        # è¨»ï¼šå…è²»ç‰ˆåªæä¾› 8 å¤©é å ±
        url = "https://api.openweathermap.org/data/2.5/forecast"
        params = {
            "lat": lat,
            "lon": lon,
            "appid": OPENWEATHER_API_KEY,
            "units": "metric",  # ä½¿ç”¨æ”æ°æº«åº¦
            "lang": "zh_tw",
        }

        response = requests.get(url, params=params, timeout=10)
        response.raise_for_status()
        data = response.json()

        # è™•ç†æ¯æ—¥å¤©æ°£è³‡æ–™
        daily_weather = {}
        for item in data.get("list", []):
            date_str = datetime.fromtimestamp(item["dt"]).strftime("%Y-%m-%d")

            if date_str not in daily_weather:
                daily_weather[date_str] = {
                    "date": date_str,
                    "temp_max": item["main"]["temp_max"],
                    "temp_min": item["main"]["temp_min"],
                    "description": item["weather"][0]["description"],
                    "rain_probability": item.get("pop", 0) * 100,
                    "temps": [item["main"]["temp"]],
                }
            else:
                daily_weather[date_str]["temp_max"] = max(
                    daily_weather[date_str]["temp_max"], item["main"]["temp_max"]
                )
                daily_weather[date_str]["temp_min"] = min(
                    daily_weather[date_str]["temp_min"], item["main"]["temp_min"]
                )
                daily_weather[date_str]["temps"].append(item["main"]["temp"])
                daily_weather[date_str]["rain_probability"] = max(
                    daily_weather[date_str]["rain_probability"],
                    item.get("pop", 0) * 100,
                )

        # è½‰æ›ç‚ºåˆ—è¡¨ä¸¦æ’åº
        weather_list = sorted(daily_weather.values(), key=lambda x: x["date"])

        # ç§»é™¤ temps æ¬„ä½
        for item in weather_list:
            item.pop("temps", None)

        return weather_list[:days]

    except Exception as e:
        print(f"å–å¾—å¤©æ°£è³‡æ–™å¤±æ•—ï¼š{e}")
        return get_mock_weather(city_name, days)


def get_mock_weather(city_name: str, days: int = 7) -> List[Dict]:
    """
    ç”¢ç”Ÿæ¨¡æ“¬å¤©æ°£è³‡æ–™ï¼ˆç•¶ç„¡ API Key æˆ– API å¤±æ•—æ™‚ä½¿ç”¨ï¼‰
    """
    weather_list = []
    today = datetime.now()

    for i in range(days):
        date = today + timedelta(days=i)
        weather_list.append(
            {
                "date": date.strftime("%Y-%m-%d"),
                "temp_max": 25 + (i % 5),
                "temp_min": 18 + (i % 3),
                "description": ["æ™´å¤©", "å¤šé›²", "é™°å¤©", "å°é›¨", "æ™´"][i % 5],
                "rain_probability": [10, 30, 50, 80, 5][i % 5],
            }
        )

    return weather_list


def format_weather_display(weather_data: List[Dict], city_name: str = "") -> str:
    """
    æ ¼å¼åŒ–å¤©æ°£è³‡è¨Šé¡¯ç¤º
    """
    if not weather_data:
        return f"{city_name} - ç„¡æ³•å–å¾—å¤©æ°£è³‡è¨Š"

    output = f"### ğŸ“ {city_name} å¤©æ°£é å ±\n\n"

    for day in weather_data:
        date_obj = datetime.strptime(day["date"], "%Y-%m-%d")
        weekday = ["é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­", "é€±æ—¥"][
            date_obj.weekday()
        ]

        # å–å¾—ç©¿æ­å»ºè­°
        suggestion = get_temperature_suggestion(day["temp_max"], day["temp_min"])

        output += f"**{day['date']} ({weekday})**\n"
        output += f"- ğŸŒ¡ï¸ æº«åº¦ï¼š{day['temp_min']:.0f}Â°C ~ {day['temp_max']:.0f}Â°C\n"
        output += f"- â˜ï¸ å¤©æ°£ï¼š{day['description']}\n"
        output += f"- ğŸŒ§ï¸ é™é›¨æ©Ÿç‡ï¼š{day['rain_probability']:.0f}%\n"
        output += f"- ğŸ‘” ç©¿æ­å»ºè­°ï¼š{suggestion}\n\n"

    return output


def get_temperature_suggestion(temp_max: float, temp_min: float) -> str:
    """
    æ ¹æ“šæº«åº¦æä¾›ç©¿æ­å»ºè­°
    """
    avg_temp = (temp_max + temp_min) / 2

    if avg_temp >= 30:
        return "ğŸ”¥ ç‚ç†±å¤©æ°£ï¼Œå»ºè­°ç©¿è‘—çŸ­è¢–ã€çŸ­è¤²ï¼Œæ³¨æ„é˜²æ›¬"
    elif avg_temp >= 25:
        return "â˜€ï¸ æº«æš–å¤©æ°£ï¼Œé©åˆç©¿è‘—è¼•è–„è¡£ç‰©"
    elif avg_temp >= 20:
        return "ğŸŒ¤ï¸ èˆ’é©å¤©æ°£ï¼Œå¯ç©¿è‘—é•·è¢–æˆ–æ­é…è–„å¤–å¥—"
    elif avg_temp >= 15:
        return "ğŸ‚ æ¶¼çˆ½å¤©æ°£ï¼Œå»ºè­°ç©¿è‘—å¤–å¥—æˆ–æ¯›è¡£"
    elif avg_temp >= 10:
        return "â„ï¸ å¯’å†·å¤©æ°£ï¼Œéœ€è¦ç©¿è‘—åšå¤–å¥—ä¿æš–"
    else:
        return "ğŸ§Š éå¸¸å¯’å†·ï¼Œå»ºè­°å¤šå±¤ç©¿æ­ä¸¦æ³¨æ„ä¿æš–"


if __name__ == "__main__":
    # æ¸¬è©¦å¤©æ°£ API
    print("=" * 60)
    print("æ¸¬è©¦ä¸­å¤®æ°£è±¡ç½²å¤©æ°£ API")
    print("=" * 60)

    # æ¸¬è©¦ 7 å¤©é å ±
    print("\nã€æ¸¬è©¦ 1ã€‘æ³°å±± 7 å¤©é å ±")
    print("-" * 60)
    weather = get_weather_forecast("æ³°å±±", 7)
    if weather:
        print(format_weather_display(weather, "æ³°å±±"))
    else:
        print("âŒ ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™")

    # æ¸¬è©¦ä¸åŒåŸå¸‚
    print("\nã€æ¸¬è©¦ 2ã€‘å°åŒ— 7 å¤©é å ±")
    print("-" * 60)
    weather = get_weather_forecast("å°åŒ—", 7)
    if weather:
        print(format_weather_display(weather, "å°åŒ—"))
    else:
        print("âŒ ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™")

    # æ¸¬è©¦ 2 å¤©é å ±ï¼ˆ36 å°æ™‚æ ¼å¼ï¼‰
    print("\nã€æ¸¬è©¦ 3ã€‘é«˜é›„ 2 å¤©é å ±ï¼ˆ36 å°æ™‚æ ¼å¼ï¼‰")
    print("-" * 60)
    weather = get_weather_forecast("é«˜é›„", 2)
    if weather:
        print(format_weather_display(weather, "é«˜é›„"))
    else:
        print("âŒ ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™")

    print("\n" + "=" * 60)
    print("æ¸¬è©¦å®Œæˆï¼")
    print("=" * 60)
